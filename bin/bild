#!/usr/bin/env python

import os
import shutil
import subprocess
import sys

SKIP = [".git", "bin", ".envrc", "_bild", "nix"]
DESK = os.environ["DESK"]

PIERS = os.environ["PIERS"].split()
FILES = subprocess.check_output(["git", "ls-files", "-mo"]).split()

for pier in PIERS:
    print("pier:", pier)
    desk = os.path.join(pier, DESK)
    if not os.path.exists(os.path.join(pier, ".http.ports")):
        print(f"fail: ship is not running")
        continue
    elif not os.path.exists(desk):
        sys.exit(f"fail: need to |mount %")
        #subprocess.run(["herb", pier, "-d", f"'|mount %'"])
    for path in FILES:
        path = path.decode('utf-8')
        if path.startswith(tuple(SKIP)):
            print("skip:", path)
            continue
        else:
            dest = os.path.join(desk, path.strip("./"))
            # switch on file extension for compilation strategy
            if path.endswith((".hoon", ".css", ".js", ".html", ".json")):
                os.makedirs(os.path.dirname(dest), exist_ok=True)
                shutil.copyfile(path, dest)
                print(f"copy: {path} -> {pier}")
            else:
                print(f"fail: no compilation strategy for {path}")
            # commit changes with herb
            # idk why urbit gives a 500 error when i try to do this
            #subprocess.run(
            #    ["herb", pier, "-p", "hood", "-d", f'"+hood/commit %{DESK}"']
            #)
    print("----")
